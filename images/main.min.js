(()=>{"use strict";var e={448:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.IFRAME_STYLE=t.POPUP_IFRAME_ID=t.IS_CART_POPUP_VIEW_SESSION_KEY=t.CART_POPUP=void 0;const o=n(57),{RECOMMENDED_DOMAIN:i}=(0,o.config)();t.CART_POPUP=`${i}/cart-popup`,t.IS_CART_POPUP_VIEW_SESSION_KEY="isViewCrmCartPopup",t.POPUP_IFRAME_ID="crm-popup-iframe",t.IFRAME_STYLE="\n    width: 100%;\n    height: 100%;\n    z-index: 9999;\n\n    position: fixed;\n    top:0;\n    left:0;\n  "},575:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.CartPopupService=void 0;const i=n(720),r=n(414),c=n(448);t.CartPopupService=class{constructor(){this.isViewedCrmCartPopup=!!sessionStorage.getItem(c.IS_CART_POPUP_VIEW_SESSION_KEY),this.body=document.querySelector("body"),this.body&&(this.prevOverflowY=window.getComputedStyle(this.body).overflowY)}init(){this.isViewedCrmCartPopup||this.configureOrderButton()}configureOrderButton(){const e=document.querySelector("._crm_btn_order"),t=e.onclick;e.removeAttribute("onClick"),e.addEventListener("click",(n=>this.handleOrderClick({callback:()=>null==t?void 0:t.call(e,n)})))}handleOrderClick(e){return o(this,arguments,void 0,(function*({callback:e}){try{const t=yield(0,i.getPopupInfoApi)();if(!t.view)return void e();this.popupInfo=t,this.handleCrmEvent({callback:e}),this.showPopup(),this.isViewedCrmCartPopup=!0,sessionStorage.setItem(c.IS_CART_POPUP_VIEW_SESSION_KEY,"true")}catch(t){e()}}))}handleCrmEvent({callback:e}){window.addEventListener("message",(t=>{const{crmEventType:n}=t.data;n===r.CRM_EVENT.CART_POPUP_PRODUCT_ADD&&(this.closePopup(),this.handleRedirect()),n===r.CRM_EVENT.CART_POPUP_STILL_BUY&&(this.closePopup(),e()),n===r.CRM_EVENT.CART_POPUP_CLOSE&&this.closePopup()}))}showPopup(){if(!this.body)return;const e=this.createIframe();this.body.appendChild(e),this.body.style.overflowY="hidden"}createIframe(){if(!this.popupInfo)throw new Error("popupInfo is not defined");const{remainingAmount:e,langCode:t,currency:n,currencyFormat:o}=this.popupInfo,i=`${c.CART_POPUP}/${e}?lang=${t}&currency=${n}&currencyFormat=${o}`,r=document.createElement("iframe");return r.src=i,r.id=c.POPUP_IFRAME_ID,r.style.cssText=c.IFRAME_STYLE,r}closePopup(){const e=document.getElementById(c.POPUP_IFRAME_ID);this.body&&e&&(this.prevOverflowY&&(this.body.style.overflowY=this.prevOverflowY),this.body.removeChild(e))}handleRedirect(){if(!this.popupInfo)throw new Error("popupInfo is not defined");const{btnUrl:e,siteMainUrl:t,siteImwebUrl:n}=this.popupInfo,o=new URL(e),i=window.location.hostname,r=o.hostname;if(i===r)return void(window.location.href=e);window.location.href=r!==t&&r!==n?e:o.pathname}}},893:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.salesToolController=void 0;const i=n(496),r=n(575),c=n(94);t.salesToolController=()=>o(void 0,void 0,void 0,(function*(){const e=window.crmService.memberCode,t=yield(0,i.getSettingsApi)();if("Y"===t.feature.upsell.isFreeShipNotify&&e&&"/shop_cart"===location.pathname){(new r.CartPopupService).init()}if("Y"===t.feature.recommendation.isRecProdPublished){new c.ProductRecommendService(t).init()}}))},94:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.ProductRecommendService=void 0;const i=n(191),r=n(916),c=n(125),s=n(414),a=n(632);t.ProductRecommendService=class{constructor(e){this.settings=e}init(){return o(this,void 0,void 0,(function*(){var e,t;const n=null!==(e=window.crmService.cartCode)&&void 0!==e?e:"",o=null!==(t=window.crmService.isRegularly)&&void 0!==t?t:"N";this.productList=yield(0,c.getRecommendProductsApi)({cart:n,isRegularly:o}),this.productList&&0!==this.productList.length&&(this.designSettings=yield(0,i.getDesignSettingsApi)(),this.showIframe(),this.handleCrmEvent())}))}showIframe(){const e=new MutationObserver((t=>{for(const n of t)if("childList"===n.type){const t=document.getElementById("_crm_recommend_product_box");if(t){const n=this.createIframe();t.appendChild(n),e.disconnect();break}}}));e.observe(document.body,{childList:!0,subtree:!0})}createIframe(){const e=a.PRODUCT_RECOMMEND,t=document.createElement("iframe");return t.src=e,t.id="recommendedListFrame",t.style.cssText=a.IFRAME_STYLE,this.iframe=t,t}handleCrmEvent(){window.addEventListener("message",(e=>o(this,void 0,void 0,(function*(){var t,n;const{crmEventType:o}=e.data;if(this.iframe){if(o===s.CRM_EVENT.PRODUCT_RECOMMEND_INIT&&(null===(n=null===(t=this.iframe)||void 0===t?void 0:t.contentWindow)||void 0===n||n.postMessage({settings:this.settings,productList:this.productList,designSettings:this.designSettings},"*")),o===s.CRM_EVENT.PRODUCT_RECOMMEND_RESIZE){const{iframeHeight:t}=e.data;this.iframe.style.height=`${t}px`}if(o===s.CRM_EVENT.PRODUCT_RECOMMEND_PRODUCT_LIKE){const{productIdx:t}=e.data;if(!window.crmService.memberCode)return void this.handleLoginModal();this.handleProductLike(t)}}}))))}handleProductLike(e){return o(this,void 0,void 0,(function*(){var t,n,o,i;yield(0,r.productLikeApi)({idx:e});const s=null!==(t=window.crmService.cartCode)&&void 0!==t?t:"",a=null!==(n=window.crmService.isRegularly)&&void 0!==n?n:"N";this.productList=yield(0,c.getRecommendProductsApi)({cart:s,isRegularly:a}),null===(i=null===(o=this.iframe)||void 0===o?void 0:o.contentWindow)||void 0===i||i.postMessage({productList:this.productList},"*")}))}handleLoginModal(){const e=btoa("/shop_cart"),t=encodeURIComponent(e);window.SITE_MEMBER.openLogin(t)}}},632:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.IFRAME_STYLE=t.PRODUCT_RECOMMEND=void 0;const o=n(57),{RECOMMENDED_DOMAIN:i}=(0,o.config)();t.PRODUCT_RECOMMEND=`${i}/cart-recommended`,t.IFRAME_STYLE="\n    width: 100%;\n    height: 0px;\n    scrolling: no;\n  "},156:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const i=n(893),r=n(233);class c{boot(e){return o(this,arguments,void 0,(function*({unitCode:e,siteCode:t,memberCode:n,cartCode:o,isRegularly:c}){if("/shop_cart"===location.pathname||"/admin/design"===location.pathname){this.unitCode=e,this.siteCode=t,this.memberCode=n,this.cartCode=o,this.isRegularly=c?"Y":"N";try{yield(0,r.getToken)(),(0,i.salesToolController)()}catch(e){}}}))}}window.crmService=new c},915:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.authApi=void 0;const i=n(57),{BASE_URL:r}=(0,i.config)();t.authApi=e=>o(void 0,void 0,void 0,(function*(){const t=yield fetch(`${r}/auth/anonymous/token`,{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error("fail to authApi");return(yield t.json()).data}))},191:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getDesignSettingsApi=void 0;const i=n(233),r=n(57),{BASE_URL:c}=(0,r.config)();t.getDesignSettingsApi=()=>o(void 0,void 0,void 0,(function*(){const e=yield(0,i.getToken)();if(!e)throw new Error("fail to auth");const t=yield fetch(`${c}/v1/common/design/settings`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error("fail to getDesignSettingsApi");return(yield t.json()).data}))},496:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getSettingsApi=void 0;const i=n(233),r=n(57),{BASE_URL:c}=(0,r.config)();t.getSettingsApi=()=>o(void 0,void 0,void 0,(function*(){const e=yield(0,i.getToken)();if(!e)throw new Error("fail to auth");const t=yield fetch(`${c}/v1/settings`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},credentials:"include"});if(!t.ok)throw new Error("fail to getSettingsApi");return(yield t.json()).data}))},916:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.productLikeApi=void 0;const i=n(233),r=n(57),{BASE_URL:c}=(0,r.config)();t.productLikeApi=e=>o(void 0,void 0,void 0,(function*(){const t=yield(0,i.getToken)();if(!t)throw new Error("fail to auth");const n=yield fetch(`${c}/v1/product/wish`,{method:"POST",body:JSON.stringify(e),headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(!n.ok)throw new Error("fail to productLikeApi");return(yield n.json()).data}))},125:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getRecommendProductsApi=void 0;const i=n(233),r=n(57),{BASE_URL:c}=(0,r.config)();t.getRecommendProductsApi=e=>o(void 0,[e],void 0,(function*({cart:e,isRegularly:t}){const n=yield(0,i.getToken)();if(!n)throw new Error("fail to auth");const o=new URLSearchParams({cart:e,isRegularly:t}).toString(),r=yield fetch(`${c}/v1/marketing/recommendation/manual/products?${o}`,{method:"GET",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"}});if(!r.ok)throw new Error("fail to getRecommendProductsApi");return(yield r.json()).data}))},720:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getPopupInfoApi=void 0;const i=n(233),r=n(57),{BASE_URL:c}=(0,r.config)();t.getPopupInfoApi=()=>o(void 0,void 0,void 0,(function*(){const e=yield(0,i.getToken)();if(!e)throw new Error("fail to auth");const t=yield fetch(`${c}/v1/marketing/upsell/cart/popup`,{method:"GET",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error("fail to getPopupInfoApi");return(yield t.json()).data}))},441:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DAY=t.HOUR=t.MINUTE=t.SECOND=void 0,t.SECOND=1e3,t.MINUTE=60*t.SECOND,t.HOUR=60*t.MINUTE,t.DAY=24*t.HOUR},414:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CRM_EVENT=void 0,t.CRM_EVENT={CART_POPUP_PRODUCT_ADD:"CRM_CART_POPUP_PRODUCT_ADD",CART_POPUP_STILL_BUY:"CRM_CART_POPUP_STILL_BUY",CART_POPUP_CLOSE:"CRM_CART_POPUP_CLOSE",PRODUCT_RECOMMEND_INIT:"CRM_PRODUCT_RECOMMEND_INIT",PRODUCT_RECOMMEND_RESIZE:"CRM_PRODUCT_RECOMMEND_RESIZE",PRODUCT_RECOMMEND_PRODUCT_LIKE:"CRM_PRODUCT_RECOMMEND_PRODUCT_LIKE"}},233:function(e,t,n){var o=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function c(e){try{a(o.next(e))}catch(e){r(e)}}function s(e){try{a(o.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}a((o=o.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.getToken=void 0;const i=n(915),r=n(441),c="crmToken",s=r.HOUR-r.MINUTE;t.getToken=()=>o(void 0,void 0,void 0,(function*(){var e;const t=window.crmService.memberCode,n=t||window.crmService.cartCode||"",o=JSON.parse(null!==(e=sessionStorage.getItem(c))&&void 0!==e?e:"{}"),r=o[n];if((null==r?void 0:r.expire)>Date.now())return r.token;const{token:a}=yield(0,i.authApi)({unitCode:window.crmService.unitCode,siteCode:window.crmService.siteCode,memberCode:t}),d=Object.assign(Object.assign({},o),{[n]:{token:a,expire:Date.now()+s}});return sessionStorage.setItem(c,JSON.stringify(d)),a}))},404:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default={MODE:"DEV",BASE_URL:"https://customer-api.crm.imtest.me",RECOMMENDED_DOMAIN:"https://recommended.crm.imtest.me"}},958:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default={MODE:"PROD",BASE_URL:"https://customer-api.crm.imweb.me",RECOMMENDED_DOMAIN:"https://sales-tool.crm.imweb.me"}},57:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.config=void 0;o(n(404));const i=o(n(958));t.config=()=>i.default}},t={};(function n(o){var i=t[o];if(void 0!==i)return i.exports;var r=t[o]={exports:{}};return e[o].call(r.exports,r,r.exports,n),r.exports})(156)})();